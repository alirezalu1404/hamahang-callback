<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Hamahang Proxy | Divar Connector</title>
  <style>
    body { font-family: Tahoma; max-width: 700px; margin: 40px auto; line-height: 1.8; }
    pre { background: #f6f8fa; padding: 10px; border-radius: 6px; direction: ltr; }
    .ok { color: green; }
    .err { color: red; }
  </style>
</head>
<body>
  <h2>🌐 Hamahang Proxy Connector</h2>
  <p>این صفحه برای ارتباط امن بین <b>دیوار</b> و <b>GitHub Actions</b> طراحی شده است.</p>
  <pre id="result">Waiting for request...</pre>

  <script>
    async function handleRequest() {
      const query = new URLSearchParams(location.search);
      const payload = query.get("payload") || "{}";
      const data = JSON.parse(payload);
      const eventType = query.get("event") || "kenar_message_created";
      const token = "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";

      try {
        const res = await fetch("https://api.github.com/repos/alirezalu1404/hamahang-callback/dispatches", {
          method: "POST",
          headers: {
            "Accept": "application/vnd.github+json",
            "Authorization": `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            event_type: eventType,
            client_payload: data
          })
        });

        if (res.status === 204) {
          document.getElementById("result").innerHTML = "✅ درخواست با موفقیت به GitHub ارسال شد.";
        } else {
          const text = await res.text();
          document.getElementById("result").innerHTML = "❌ خطا: " + text;
        }
      } catch (e) {
        document.getElementById("result").innerHTML = "⚠️ Exception: " + e.message;
      }
    }

    handleRequest();
  </script>
</body>
</html>
